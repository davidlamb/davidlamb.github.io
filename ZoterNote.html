
<!DOCTYPE html>
<html>
    <head>
        <title>Client-Side JavaScript Code Sample</title>
        <script src="constants.js"></script>
        <script src="https://js.live.net/v5.0/wl.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    </head>
    <body>
        <div>    
			<h1>Live Connect JavaScript Code Sample</h1>
			<button id="signin">Sign In</button><br /><br />
			<div id="output">You are not currently signed in.</div>
		</div>
        <label id="info"></label>
        <script>
			  
			  var zoteroData = {
				d:null,
				getData: function(data, callback) { 
				  var request = document.createTextNode(JSON.stringify(data));
				  request.addEventListener("ZoterNote-response", function(event) {
					request.parentNode.removeChild(request);

					if (callback) {
						
						var response = JSON.parse(request.nodeValue);
						callback(response);
					}
				  }, false);

				  document.head.appendChild(request);

				  var event = document.createEvent("HTMLEvents");
				  event.initEvent("ZoterNote-query", true, false);
				  request.dispatchEvent(event);
				},

				callback: function(response) {
					this.d = response;
					console.log(this.d);
					
					
					return true;
				}
			  }
			 //for testing remove this line
			zoteroData.getData({"ready":true},zoteroData.callback)
			
			
			
	    WL.init({
                client_id: APP_CLIENT_ID,
                redirect_uri: "http://davidlamb.github.io/zoternotecallback.html",
                scope: ["wl.signin","office.onenote_create","wl.offline_access"],
                response_type: "token"
            });
            WL.Event.subscribe("auth.login", onLogin);
			signInButton = document.getElementById("signin");
			signInButton.onclick = signIn;
			
			function signIn(){
				//console.log(WL.getSession());
				var session = WL.getSession();
				if (session){
					console.log("You are already signed in!")
					zoteroData.getData({"ready":true},zoteroData.callback)
				}else{
					console.log("Logging In")
					WL.login({scope:"wl.signin"}).then(
						function(){
							console.log("Log in successful");
							zoteroData.getData({"ready":true},zoteroData.callback)
						},
						function(response){
							console.log("Could not connect, status = " + response.status);
						});
				}
			}
            

            function onLogin () {
				var session = WL.getSession();
				console.log("OnLogin was finally called...");
                if (!session.error) {
                    WL.api({
                        path: "me",
                        method: "GET"
                    }).then(
                        function (response) {
                            document.getElementById("info").innerText =
                                "Hello, " + response.first_name + " " + response.last_name + "!";
                        },
                        function (responseFailed) {
                            document.getElementById("info").innerText =
                                "Error calling API: " + responseFailed.error.message;
                        }
                    );
                }
                else {
                    document.getElementById("info").innerText =
                        "Error signing in: " + session.error_description;
                }
            }
        </script>                   
                
    </body>
</html>