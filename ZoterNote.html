
<!DOCTYPE html>
<html>
    <head>
        <title>Client-Side JavaScript Code Sample</title>
        <script src="constants.js"></script>
        <script src="https://js.live.net/v5.0/wl.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    </head>
    <body>
        <div>    
			<h1>Please log into your OneNote/OneDrive account.</h1>
			<button id="signin">Sign In</button><br /><br />
			<label id="info"></label>
		</div>
        
        <script>
			  
			  var zoteroData = {
				d:null,
				getData: function(data, callback) { 
				  var request = document.createTextNode(JSON.stringify(data));
				  request.addEventListener("ZoterNote-response", function(event) {
					request.parentNode.removeChild(request);

					if (callback) {
						
						var response = JSON.parse(request.nodeValue);
						callback(response);
					}
				  }, false);

				  document.head.appendChild(request);

				  var event = document.createEvent("HTMLEvents");
				  event.initEvent("ZoterNote-query", true, false);
				  request.dispatchEvent(event);
				},

				callback: function(response) {
					this.d = response;
					return true;
				}
			  }
			 //for testing remove this line
			zoteroData.getData({"ready":true},zoteroData.callback)
			
			
			
	    WL.init({
                client_id: APP_CLIENT_ID,
                redirect_uri: "http://davidlamb.github.io/zoternotecallback.html",
                scope: ["wl.signin","office.onenote_create","wl.offline_access"],
                response_type: "token"
            });
            //WL.Event.subscribe("auth.login", onLogin);
	   
	    signInButton = document.getElementById("signin");
	    signInButton.onclick = signIn;
	    var session = WL.getSession();
	    if (session) {
		document.getElementById("info").innerText = "You are currently logged in...";
		submitData();
	    }else{
		document.getElementById("info").innerText = "You are not logged in...";
	    }
	    function signIn(){
		    //console.log(WL.getSession());
		    
		    if (session){
			    console.log("You are already signed in!")
			    console.log(session)
			    //zoteroData.getData({"ready":true},zoteroData.callback)
		    }else{
			console.log("Logging In")
			WL.login({scope:["wl.signin","office.onenote_create","wl.offline_access"]}).then(
				function(response){
					console.log("Log in successful");
					console.log(response);
					console.log(session);
					document.getElementById("info").innerText = "Hello, " + response.first_name + " " + response.last_name + "!";
					//zoteroData.getData({"ready":true},zoteroData.callback);
				},
				function(response){
					console.log("Could not connect, status = " + response.status);
				});
		    }
	    }
            
	    function submitData(){
		if (zoteroData.d) {
		    for (var i =0;i<zoteroData.d.length;i++){
			console.log(zoteroData.d[i]);
		    }
		    
		}else{
		    document.getElementById("info").innerText = "You don't have any data to submit";
		}

	    }

            function onLogin () {
		
		console.log("OnLogin was finally called...");
                if (!session.error) {
                    WL.api({
                        path: "me",
                        method: "GET"
                    }).then(
                        function (response) {
                            document.getElementById("info").innerText =
                                "Hello, " + response.first_name + " " + response.last_name + "!";
                        },
                        function (responseFailed) {
                            document.getElementById("info").innerText =
                                "Error calling API: " + responseFailed.error.message;
                        }
                    );
                }
                else {
                    document.getElementById("info").innerText =
                        "Error signing in: " + session.error_description;
                }
            }
        </script>                   
                
    </body>
</html>